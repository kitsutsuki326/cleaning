<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>掃除スケジュール管理 Pro</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // --- Icons (Added new ones for the features) ---
        const Home = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
        );
        const Plus = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <line x1="12" x2="12" y1="5" y2="19"></line>
                <line x1="5" x2="19" y1="12" y2="12"></line>
            </svg>
        );
        const Trash2 = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" x2="10" y1="11" y2="17"></line>
                <line x1="14" x2="14" y1="11" y2="17"></line>
            </svg>
        );
        const Check = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        );
        const AlertCircle = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" x2="12" y1="8" y2="12"></line>
                <line x1="12" x2="12.01" y1="16" y2="16"></line>
            </svg>
        );
        const RotateCcw = ({ size = 16, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                <path d="M3 3v5h5"></path>
            </svg>
        );
        const ListTodo = ({ size = 18, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="m3 17 2 2 4-4"></path>
                <path d="m3 7 2 2 4-4"></path>
                <path d="M13 6h8"></path>
                <path d="M13 12h8"></path>
                <path d="M13 18h8"></path>
            </svg>
        );
        const Calendar = ({ size = 18, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect>
                <line x1="16" x2="16" y1="2" y2="6"></line>
                <line x1="8" x2="8" y1="2" y2="6"></line>
                <line x1="3" x2="21" y1="10" y2="10"></line>
            </svg>
        );
        const Bell = ({ size = 18, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path>
                <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path>
            </svg>
        );

        // Icon lookup for original icon options
        const Droplets = (props) => (
            <svg {...props} width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.84-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"></path>
                <path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"></path>
            </svg>
        );
        const Bath = (props) => (
            <svg {...props} width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M9 6 6.5 3.5a1.5 1.5 0 0 0-1-.5C4.683 3 4 3.683 4 4.5V17a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-5"></path>
                <line x1="10" x2="8" y1="5" y2="7"></line>
                <line x1="2" x2="22" y1="12" y2="12"></line>
                <line x1="7" x2="7" y1="19" y2="21"></line>
                <line x1="17" x2="17" y1="19" y2="21"></line>
            </svg>
        );
        const Bed = (props) => (
            <svg {...props} width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M2 4v16"></path>
                <path d="M2 8h18a2 2 0 0 1 2 2v10"></path>
                <path d="M2 17h20"></path>
                <path d="M6 8v9"></path>
            </svg>
        );
        const Utensils = (props) => (
            <svg {...props} width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"></path>
                <path d="M7 2v20"></path>
                <path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"></path>
            </svg>
        );
        const Coffee = (props) => (
            <svg {...props} width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M17 8h1a4 4 0 1 1 0 8h-1"></path>
                <path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"></path>
                <line x1="6" x2="6" y1="2" y2="4"></line>
                <line x1="10" x2="10" y1="2" y2="4"></line>
                <line x1="14" x2="14" y1="2" y2="4"></line>
            </svg>
        );

        function CleaningScheduleApp() {
          const [rooms, setRooms] = useState([]);
          const [showAddRoom, setShowAddRoom] = useState(false);
          const [notificationPermission, setNotificationPermission] = useState('default');
          const [newRoom, setNewRoom] = useState({
            name: '',
            frequency: 7,
            icon: 'home'
          });

          const iconOptions = [
            { value: 'home', label: 'リビング', Icon: Home },
            { value: 'droplets', label: 'バスルーム', Icon: Droplets },
            { value: 'bath', label: 'トイレ', Icon: Bath },
            { value: 'bed', label: '寝室', Icon: Bed },
            { value: 'utensils', label: 'キッチン', Icon: Utensils },
            { value: 'coffee', label: 'ダイニング', Icon: Coffee },
          ];

          useEffect(() => {
            const saved = localStorage.getItem('cleaning-rooms-pro');
            if (saved) {
              setRooms(JSON.parse(saved));
            }
            if ("Notification" in window) {
              setNotificationPermission(Notification.permission);
            }
          }, []);

          useEffect(() => {
            localStorage.setItem('cleaning-rooms-pro', JSON.stringify(rooms));
            // Check for overdue rooms to notify
            if (notificationPermission === 'granted') {
              const overdueCount = rooms.filter(r => getUrgencyLevel(r) === 'overdue').length;
              if (overdueCount > 0) {
                new Notification("掃除リマインダー", {
                  body: `${overdueCount}箇所の掃除期限が切れています！`,
                  icon: "https://cdn-icons-png.flaticon.com/512/995/995053.png"
                });
              }
            }
          }, [rooms]);

          const requestNotification = () => {
            Notification.requestPermission().then(permission => {
              setNotificationPermission(permission);
            });
          };

          const addRoom = () => {
            if (newRoom.name.trim()) {
              setRooms([...rooms, {
                id: Date.now(),
                name: newRoom.name,
                frequency: newRoom.frequency,
                icon: newRoom.icon,
                lastCleaned: null,
                history: [],
                tasks: [] // Added for tasks feature
              }]);
              setNewRoom({ name: '', frequency: 7, icon: 'home' });
              setShowAddRoom(false);
            }
          };

          const markAsCleaned = (id) => {
            const now = new Date().toISOString();
            setRooms(rooms.map(room =>
              room.id === id
                ? {
                    ...room,
                    lastCleaned: now,
                    history: [...(room.history || []), now].slice(-10)
                  }
                : room
            ));
          };

          // Feature: Undo Cleaned
          const undoCleaned = (id) => {
            setRooms(rooms.map(room => {
              if (room.id === id && room.history && room.history.length > 0) {
                const newHistory = [...room.history];
                newHistory.pop(); // Remove the latest
                return {
                  ...room,
                  lastCleaned: newHistory.length > 0 ? newHistory[newHistory.length - 1] : null,
                  history: newHistory
                };
              }
              return room;
            }));
          };

          // Feature: Task Management
          const addTask = (roomId, taskText) => {
            if (!taskText.trim()) return;
            setRooms(rooms.map(room =>
              room.id === roomId
                ? { ...room, tasks: [...(room.tasks || []), { id: Date.now(), text: taskText, completed: false }] }
                : room
            ));
          };

          const toggleTask = (roomId, taskId) => {
            setRooms(rooms.map(room =>
              room.id === roomId
                ? { ...room, tasks: room.tasks.map(t => t.id === taskId ? { ...t, completed: !t.completed } : t) }
                : room
            ));
          };

          const deleteTask = (roomId, taskId) => {
            setRooms(rooms.map(room =>
              room.id === roomId
                ? { ...room, tasks: room.tasks.filter(t => t.id !== taskId) }
                : room
            ));
          };

          // Feature: Calendar Integration (Google Calendar Link)
          const getCalendarUrl = (room) => {
            const last = room.lastCleaned ? new Date(room.lastCleaned) : new Date();
            const nextDate = new Date(last);
            nextDate.setDate(nextDate.getDate() + room.frequency);
            
            const fmt = (d) => d.toISOString().replace(/-|:|\.\d\d\d/g, "");
            const start = fmt(nextDate);
            const end = fmt(new Date(nextDate.getTime() + 30 * 60000));
            
            return `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(room.name + 'の掃除')}&dates=${start}/${end}&details=掃除の予定日です`;
          };

          const deleteRoom = (id) => {
            if(confirm('この部屋を削除しますか？')) {
              setRooms(rooms.filter(room => room.id !== id));
            }
          };

          const getDaysSinceLastCleaned = (lastCleaned) => {
            if (!lastCleaned) return null;
            const now = new Date();
            const last = new Date(lastCleaned);
            return Math.floor((now - last) / (1000 * 60 * 60 * 24));
          };

          const getUrgencyLevel = (room) => {
            const daysSince = getDaysSinceLastCleaned(room.lastCleaned);
            if (daysSince === null) return 'never';
            const ratio = daysSince / room.frequency;
            if (ratio >= 1.5) return 'overdue';
            if (ratio >= 1) return 'urgent';
            if (ratio >= 0.7) return 'soon';
            return 'clean';
          };

          const getUrgencyColor = (level) => {
            switch (level) {
              case 'never': return 'bg-gray-100 border-gray-300 text-gray-600';
              case 'overdue': return 'bg-red-50 border-red-400 text-red-800 shadow-lg shadow-red-100';
              case 'urgent': return 'bg-orange-50 border-orange-400 text-orange-800 shadow-md shadow-orange-100';
              case 'soon': return 'bg-yellow-50 border-yellow-400 text-yellow-800';
              case 'clean': return 'bg-green-50 border-green-400 text-green-800';
              default: return 'bg-gray-100 border-gray-300';
            }
          };

          const getUrgencyMessage = (room) => {
            const level = getUrgencyLevel(room);
            const daysSince = getDaysSinceLastCleaned(room.lastCleaned);
            if (level === 'never') return '未掃除';
            if (level === 'overdue') return `${daysSince}日経過 - 至急！`;
            if (level === 'urgent') return `${daysSince}日経過 - 掃除が必要`;
            if (level === 'soon') return `${daysSince}日経過 - そろそろ`;
            return `${daysSince}日経過 - まだ綺麗`;
          };

          const sortedRooms = [...rooms].sort((a, b) => {
            const urgencyOrder = { overdue: 0, urgent: 1, never: 2, soon: 3, clean: 4 };
            return urgencyOrder[getUrgencyLevel(a)] - urgencyOrder[getUrgencyLevel(b)];
          });

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 p-4 sm:p-8">
              <div className="max-w-4xl mx-auto">
                {/* Header Section */}
                <div className="bg-white rounded-2xl shadow-xl overflow-hidden mb-6">
                  <div className="bg-gradient-to-r from-blue-600 to-indigo-700 p-6 sm:p-8">
                    <div className="flex justify-between items-start">
                      <div>
                        <h1 className="text-3xl sm:text-4xl font-bold text-white mb-2 flex items-center gap-3">
                          <Home size={36} />
                          掃除管理 Pro
                        </h1>
                        <p className="text-blue-100">
                          タスクと通知で清潔な環境を維持
                        </p>
                      </div>
                      {notificationPermission !== 'granted' && (
                        <button 
                          onClick={requestNotification}
                          className="bg-white/20 hover:bg-white/30 text-white p-2 rounded-full transition-colors"
                          title="通知を許可"
                        >
                          <Bell size={24} />
                        </button>
                      )}
                    </div>
                  </div>

                  <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 p-6 bg-gray-50 text-center">
                    <div><div className="text-2xl font-bold text-gray-800">{rooms.length}</div><div className="text-xs text-gray-600">登録</div></div>
                    <div><div className="text-2xl font-bold text-red-600">{rooms.filter(r => getUrgencyLevel(r) === 'overdue').length}</div><div className="text-xs text-gray-600">至急</div></div>
                    <div><div className="text-2xl font-bold text-orange-600">{rooms.filter(r => getUrgencyLevel(r) === 'urgent').length}</div><div className="text-xs text-gray-600">要対応</div></div>
                    <div><div className="text-2xl font-bold text-green-600">{rooms.filter(r => getUrgencyLevel(r) === 'clean').length}</div><div className="text-xs text-gray-600">綺麗</div></div>
                  </div>
                </div>

                {!showAddRoom && (
                  <button
                    onClick={() => setShowAddRoom(true)}
                    className="w-full mb-6 bg-white hover:bg-blue-50 border-2 border-dashed border-blue-300 rounded-xl p-4 text-blue-600 font-medium transition-colors flex items-center justify-center gap-2"
                  >
                    <Plus size={20} />
                    新しい部屋を追加
                  </button>
                )}

                {/* Add Room Form (Original UI) */}
                {showAddRoom && (
                  <div className="bg-white rounded-xl shadow-lg p-6 mb-6 border-2 border-blue-300">
                    <h3 className="font-bold text-lg mb-4 text-gray-800">新しい部屋を追加</h3>
                    <div className="space-y-4">
                      <input
                        type="text"
                        value={newRoom.name}
                        onChange={(e) => setNewRoom({ ...newRoom, name: e.target.value })}
                        placeholder="部屋名 (例: キッチン)"
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                      />
                      <input
                        type="number"
                        value={newRoom.frequency}
                        onChange={(e) => setNewRoom({ ...newRoom, frequency: parseInt(e.target.value) })}
                        placeholder="頻度（日）"
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                      />
                      <div className="grid grid-cols-6 gap-2">
                        {iconOptions.map(({ value, Icon }) => (
                          <button
                            key={value}
                            onClick={() => setNewRoom({ ...newRoom, icon: value })}
                            className={`p-2 rounded border-2 ${newRoom.icon === value ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}
                          >
                            <Icon size={20} className="mx-auto" />
                          </button>
                        ))}
                      </div>
                      <div className="flex gap-2">
                        <button onClick={addRoom} className="flex-1 bg-blue-600 text-white py-2 rounded-lg">追加</button>
                        <button onClick={() => setShowAddRoom(false)} className="flex-1 bg-gray-200 py-2 rounded-lg">キャンセル</button>
                      </div>
                    </div>
                  </div>
                )}

                {/* Room List */}
                <div className="space-y-4">
                  {sortedRooms.map(room => {
                    const urgencyLevel = getUrgencyLevel(room);
                    const IconComponent = iconOptions.find(opt => opt.value === room.icon)?.Icon || Home;
                    
                    return (
                      <div key={room.id} className={`rounded-xl p-5 border-2 transition-all ${getUrgencyColor(urgencyLevel)}`}>
                        <div className="flex items-start justify-between mb-4">
                          <div className="flex items-center gap-3">
                            <div className="bg-white p-2 rounded-lg shadow-sm"><IconComponent size={24} /></div>
                            <div>
                              <h3 className="font-bold text-lg">{room.name}</h3>
                              <p className="text-xs opacity-75">{room.frequency}日ごと</p>
                            </div>
                          </div>
                          <div className="flex gap-2">
                            <a href={getCalendarUrl(room)} target="_blank" rel="noopener noreferrer" className="p-2 text-gray-500 hover:text-blue-600" title="Googleカレンダーに登録">
                              <Calendar size={20} />
                            </a>
                            <button onClick={() => deleteRoom(room.id)} className="p-2 text-gray-400 hover:text-red-600"><Trash2 size={20} /></button>
                          </div>
                        </div>

                        {/* Task Section */}
                        <div className="mb-4 bg-white/40 rounded-lg p-3">
                          <div className="flex items-center gap-2 mb-2 text-sm font-bold">
                            <ListTodo size={16} /> タスク
                          </div>
                          <div className="space-y-1 mb-2">
                            {(room.tasks || []).map(task => (
                              <div key={task.id} className="flex items-center justify-between bg-white/60 p-1 px-2 rounded">
                                <label className="flex items-center gap-2 flex-1 cursor-pointer">
                                  <input type="checkbox" checked={task.completed} onChange={() => toggleTask(room.id, task.id)} className="rounded text-blue-600" />
                                  <span className={`text-sm ${task.completed ? 'line-through opacity-50' : ''}`}>{task.text}</span>
                                </label>
                                <button onClick={() => deleteTask(room.id, task.id)} className="text-gray-400 hover:text-red-500 text-xs">×</button>
                              </div>
                            ))}
                          </div>
                          <input 
                            type="text" 
                            placeholder="+ タスクを追加" 
                            className="w-full text-xs p-1 px-2 bg-white/80 border-none rounded focus:ring-1 focus:ring-blue-400"
                            onKeyDown={(e) => {
                              if (e.key === 'Enter') {
                                addTask(room.id, e.target.value);
                                e.target.value = '';
                              }
                            }}
                          />
                        </div>

                        <div className="flex items-center justify-between">
                          <div className="flex flex-col">
                            <div className="flex items-center gap-2 text-sm font-semibold">
                              {urgencyLevel === 'overdue' && <AlertCircle size={16} />}
                              {getUrgencyMessage(room)}
                            </div>
                            {room.lastCleaned && (
                              <div className="flex items-center gap-2 mt-1">
                                <span className="text-xs opacity-60">最終: {new Date(room.lastCleaned).toLocaleDateString('ja-JP')}</span>
                                <button 
                                  onClick={() => undoCleaned(room.id)} 
                                  className="flex items-center gap-1 text-[10px] bg-gray-200/50 hover:bg-gray-200 px-1 rounded transition-colors"
                                  title="完了を取り消す"
                                >
                                  <RotateCcw size={10} /> 戻す
                                </button>
                              </div>
                            )}
                          </div>
                          <button
                            onClick={() => markAsCleaned(room.id)}
                            className="bg-white hover:shadow-inner px-4 py-2 rounded-lg font-bold shadow-sm flex items-center gap-2 text-sm"
                          >
                            <Check size={18} /> 掃除完了
                          </button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CleaningScheduleApp />);
    </script>
</body>
</html>
